---
import "@/styles/global.css";
import Layout from "@/layouts/Layout.astro";
import Hero from "@/components/home/hero-section";
import AboutSection from "@/components/home/AboutSection.astro";
import { ui, languages } from "@/i18n/ui";
import CentersSection from "@/components/home/CentersSection.astro";
import LatestNews from "@/components/home/LatestNews.astro";
import { getLangFromUrl } from "@/lib/i18n";
import { getBlogPosts } from "@/lib/blog";
import { HOME_PAGE_TITLE } from "@/consts";
import { getAllVideos } from "@/lib/youtube";
import FunctionalHome from "@/components/home/FunctionalHome.astro";
import VideoListHome from "@/components/home/VideoListHome.astro";
import { getImage } from "astro:assets";

import computerLab from "@/assets/our-centers/our-service/computer-lab-2.webp";
import trainingRoom from "@/assets/home/training-room.webp";
import publicHall from "@/assets/home/public-hall.webp";
import postOffice from "@/assets/home/post-office.webp";
import ctcImage from "@/assets/image-assets/about-ctc-1.webp";

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = getLangFromUrl(Astro.url);
const translations = ui[lang];
const posts = await getBlogPosts(lang);

// Fetch all videos and flatten to get latest across all playlists
const videosByPlaylist = await getAllVideos();
const videos = Object.values(videosByPlaylist)
  .flat()
  .sort(
    (a, b) =>
      new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime()
  )
  .slice(0, 3);

const slides = await Promise.all(
  [
    {
      image: ctcImage,
      title: "communitytechcenter",
      description: "home.hero.ctc.description",
      href: `/${lang}/about/about-us/`,
    },
    {
      image: computerLab,
      title: "home.service.computerlab",
      description: "home.service.computerlab.description",
    },
    {
      image: trainingRoom,
      title: "home.service.trainingroom",
      description: "home.service.trainingroom.description",
    },
    {
      image: postOffice,
      title: "home.service.postoffice",
      description: "home.service.postoffice.description",
    },
    {
      image: publicHall,
      title: "home.service.publichall",
      description: "home.service.publichall.description",
    },
  ].map(async (slide) => ({
    ...slide,
    image: (await getImage({ src: slide.image, format: "webp", quality: 80 }))
      .src,
  }))
);
---

<Layout
  pageTitle={HOME_PAGE_TITLE.title}
  description={HOME_PAGE_TITLE.description}
  type="website"
>
  <Hero lang={lang} translations={translations} slides={slides} client:load />
  <AboutSection lang={lang} translations={translations} />
  <VideoListHome videos={videos} lang={lang} translations={translations} />
  <FunctionalHome lang={lang} translations={translations} />
  <CentersSection lang={lang} translations={translations} />
  <LatestNews posts={posts} translations={translations} lang={lang} />
</Layout>
